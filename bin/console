#!/usr/local/bin/php
<?php

declare(strict_types=1);

use App\Company\CompanyCrawler;
use App\Company\Crawler\Analysis\EarningsEstimateCrawler;
use App\Company\Crawler\CompanyFullNameCrawler;
use App\Company\Crawler\Summary\EstimateReturnCrawler;
use App\Company\ReadModel\Ticker;
use App\FinYahoo;
use Symfony\Component\HttpClient\HttpClient;

require dirname(__DIR__) . '/vendor/autoload.php';

Dotenv\Dotenv::createImmutable(__DIR__)->load();

$summaryCrawler = new CompanyCrawler(
    'https://finance.yahoo.com/quote/%s',
    [
        'CompanyFullName' => new CompanyFullNameCrawler(),
        'EstimateReturn' => new EstimateReturnCrawler(),
    ]
);

$analysisCrawler = new CompanyCrawler(
    'https://finance.yahoo.com/quote/%s/analysis',
    [
        'EarningsEstimate' => new EarningsEstimateCrawler(),
    ]
);

$financeYahoo = new FinYahoo(
    HttpClient::create(),
    $summaryCrawler,
    $analysisCrawler
);

$companies = $financeYahoo->crawlStock(...createTickersFromEnv());

dump($companies);

/**
 * @return Ticker[] based on the .env TICKERS array
 */
function createTickersFromEnv(): array
{
    try {
        return array_map(
            static fn (string $symbol) => new Ticker($symbol),
            json_decode($_ENV['TICKERS'], true, 512, JSON_THROW_ON_ERROR)
        );
    } catch (JsonException $e) {
        die($e->getMessage());
    }
}
